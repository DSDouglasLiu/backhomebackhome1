<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>車流退場-手機版</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#f0f4f8;font-family:system-ui,-apple-system,sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;color:#333}
h1{color:#1f6fe5;margin-bottom:10px}
p{color:#666;margin-bottom:40px}
#google-btn{margin-top:20px}
#app{display:none;flex-direction:column;align-items:center;padding:20px}
header{position:fixed;top:0;left:0;right:0;height:56px;background:#1f6fe5;color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:100}
header button{background:none;border:none;color:#fff;font-size:24px}
#tabs{overflow-x:auto;white-space:nowrap;padding:12px 0;background:#fff;width:100%;box-shadow:0 2px 4px rgba(0,0,0,.1);-webkit-overflow-scrolling:touch}
.tab{background:#eee;padding:8px 16px;margin:0 6px;border-radius:20px;font-weight:600}
.tab.active{background:#1f6fe5;color:#fff}
#content{width:100%;max-width:600px;margin-top:70px;padding:0 16px}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,.1)}
.row{display:flex;gap:12px}
.box{flex:1;background:#f8f9fa;padding:12px;border-radius:12px;text-align:center;cursor:pointer}
.num{font-size:28px;font-weight:800}
.loc{display:flex;gap:12px;overflow-x:auto;padding:16px 0}
.loc>div{min-width:100px;background:#fff;padding:12px;border-radius:12px;text-align:center;border:1px solid #ddd}
</style>
</head>
<body>

<div id="login">
  <h1>車流人流退場情報</h1>
  <p>請登入以瀏覽看板</p>
  <div id="google-btn"></div>
</div>

<div id="app">
  <header>
    <button id="refresh">Refresh</button>
    <span style="font-weight:700">手機版看板</span>
    <button id="logout">Logout</button>
  </header>
  <div id="tabs"></div>
  <div id="content"></div>
</div>

<script>
const API='https://script.google.com/macros/s/AKfycbyet306bK0Tufby0083U05rZS_DwswPD62YQIMIjT154irK_nS1n9Iuf2TEZvnXjmUgGw/exec';
const CID='368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const CFG=[{k:'遊覽車平台',s:'地區專車退場（遊覽車平台）',c:'#059669',steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台搭車','車第二次上遊覽車平台','車已離開遊覽車平台'],sec:['退場人員已到齊','人已前往平台搭車']},
{k:'禪堂平台',s:'地區專車退場（禪堂平台）',c:'#f97316',steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車停靠位置','人已前往禪堂平台搭車','車已離開禪堂平台'],sec:['人已前往禪堂平台搭車','車已離開禪堂平台']},
{k:'水陸專車',s:'水陸專車退場',c:'#7c3aed',steps:['已 Call 車排車隊','已排好車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','人從車庫前往平台搭車','車已離開遊覽車平台'],sec:['退場人員已到齊','人從車庫前往平台搭車']},
{k:'288法青',s:'288法青退場',c:'#db2777',steps:['退場人員已到齊','車已上遊覽車平台','車已離開遊覽車平台'],sec:[]}];
const STOPS=['P 禪堂平台','P 法心北路','P 法心南路（西）','P 法心南路（東）','P 法大路','P 雙環路至法大一橋'];

let token=localStorage.getItem('t'),user=null,key=CFG[0].k,data={};

window.onload=()=>{
  if(token){v(token);}else{google.accounts.id.renderButton(document.getElementById('google-btn'),{theme:'outline',size:'large'});}
  google.accounts.id.initialize({client_id:CID,callback:r=>{token=r.credential;localStorage.setItem('t',token);v(token);}});
  document.getElementById('refresh').onclick=()=>load(1);
  document.getElementById('logout').onclick=()=>{localStorage.removeItem('t');location.reload();}
};

async function v(t){
  const r=await fetch(API+'?action=verify',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({idToken:t})});
  const j=await r.json();
  if(j.error){localStorage.removeItem('t');location.reload();return;}
  user=j;
  document.getElementById('login').style.display='none';
  document.getElementById('app').style.display='block';
  tabs();load(1);
}

function tabs(){
  const c=document.getElementById('tabs');c.innerHTML='';
  CFG.forEach(o=>{
    const b=document.createElement('span');
    b.className='tab';b.textContent=o.k;b.onclick=()=>{key=o.k;document.documentElement.style.setProperty('--primary',o.c);document.querySelectorAll('.tab').forEach(x=>x.classList.toggle('active',x===b));load(1);};
    if(o.k===key)b.classList.add('active');
    c.appendChild(b);
  });
}

async function load(f=0){
  const cfg=CFG.find(x=>x.k===key);
  const r=await fetch(`${API}?action=get&sheet=${encodeURIComponent(cfg.s)}&idToken=${token}`);
  const j=await r.json();
  const d=p(j.values||[],cfg);
  data[key]=d;render(d);
}

function p(v,cfg){
  if(!v.length)return{rows:[]};
  let h=-1;for(let i=0;i<10;i++)if(v[i]&&v[i].join('').includes('車號')){h=i;break;}
  if(h<0)return{rows:[]};
  const head=v[h].map(s=>s.trim());
  const a=head.findIndex(c=>c.includes('區域')||c.includes('編號'));
  const c=head.findIndex(x=>x.includes('車號'));
  const rows=[];
  for(let i=h+1;i<v.length;i++)if(v[i][a]&&v[i][c])rows.push({d:v[i],r:i+1});
  return{head,rows,a,c,cfg};
}

function render(d){
  const c=document.getElementById('content');c.innerHTML='';
  if(!d.rows.length){c.innerHTML='<div style="text-align:center;padding:60px;color:#999">無資料</div>';return;}
  const stopI=d.cfg.steps.indexOf('車暫停位置');const stopI2=d.cfg.steps.indexOf('車停靠位置');
  const stopIdx=stopI!==-1?stopI:(stopI2!==-1?stopI2:-1);
  const stopName=stopIdx>=0?d.cfg.steps[stopIdx]:null;
  const inS=stopIdx>=0?d.cfg.steps.slice(0,stopIdx):d.cfg.steps;
  const outS=stopIdx>=0?d.cfg.steps.slice(stopIdx+1):[];

  const cnt=s=>{let col=d.head.indexOf(s),done=0; d.rows.forEach(r=>{if(col>=0&&r.d[col]&&r.d[col]!=='—')done++;});return{done,todo:d.rows.length-done};};

  if(inS.length){c.innerHTML+='<div class="title" style="margin:20px 0 10px;font-weight:700;color:#444">進場程序</div>';inS.forEach(s=>c.appendChild(card(s,cnt(s),d.cfg.sec.includes(s))));}
  if(stopName){
    const can=user.permission==='全功能';
    const stopCol=d.head.indexOf(stopName);
    if(can&&stopIdx>0){
      const prev=d.cfg.steps[stopIdx-1];
      const pcol=d.head.indexOf(prev);
      const ready=d.rows.filter(r=>(!r.d[stopCol]||r.d[stopCol]==='—')&&(pcol>=0&&r.d[pcol]&&r.d[pcol]!=='—'));
      if(ready.length){
        let h=`<div class="title" style="margin:20px 0 10px">${stopName}登錄</div><select id="L"><option value="">請選擇位置</option>`;
        STOPS.forEach(o=>h+=`<option>${o}</option>`);
        h+=`</select><select id="C"><option value="">請選擇車輛</option>`;
        ready.forEach(r=>h+=`<option value="${r.r}">${r.d[d.a]||''} ${r.d[d.c]||''}</option>`);
        h+=`</select><button id="A" style="margin-top:12px;width:100%;background:#1f6fe5;color:#fff;padding:14px;border:none;border-radius:12px;font-size:16px">確定</button>`;
        const div=document.createElement('div');div.className='card';div.innerHTML=h;c.appendChild(div);
        document.getElementById('A').onclick=()=>{const l=document.getElementById('L').value;const cr=document.getElementById('C').value;if(l&&cr)upd(d.cfg,parseInt(cr),stopCol+1,l);};
      }
    }
    const loc=document.createElement('div');loc.className='loc';
    const cc={};STOPS.forEach(o=>cc[o]=0);
    d.rows.forEach(r=>{const v=stopCol>=0?r.d[stopCol]?r.d[stopCol].trim():'' :'';if(STOPS.includes(v))cc[v]++;});
    STOPS.forEach(o=>{
      const b=document.createElement('div');
      b.innerHTML=`<div style="font-size:13px;color:#666;margin-bottom:4px">${o}</div><div style="font-size:24px;font-weight:800;color:#1f6fe5">${cc[o]}</div>`;
      b.onclick=()=>list(stopName,'loc',o);
      loc.appendChild(b);
    });
    c.appendChild(loc);
  }
  if(outS.length){c.innerHTML+='<div class="title" style="margin:20px 0 10px">退場程序</div>';outS.forEach(s=>c.appendChild(card(s,cnt(s),d.cfg.sec.includes(s))));}
}

function card(t,n,s){
  const d=document.createElement('div');d.className='card'+(s?' orange':'');
  d.innerHTML=`<div class="title">${t}</div><div class="row">
    <div class="box" onclick="list('${t}','done')"><div class="num" style="color:#1f6fe5">${n.done}</div><div style="font-size:13px;margin-top:4px">完成</div></div>
    <div class="box" onclick="list('${t}','todo')"><div class="num" style="color:#ef4444">${n.todo}</div><div style="font-size:13px;margin-top:4px">未完成</div></div>
  </div>`;
  return d;
}

function list(step,type,loc=''){
  const d=data[key];
  const col=d.head.indexOf(step);
  const arr=[];
  d.rows.forEach(r=>{
    const v=col>=0?r.d[col]?r.d[col].trim():'' :'';
    const done=v&&v!=='—';
    if(type==='loc'&&v===loc)arr.push(r);
    else if(type==='done'&&done)arr.push(r);
    else if(type==='todo'&&!done)arr.push(r);
  });
  let h=`<div style="padding:16px;font-weight:700;border-bottom:1px solid #eee">${step}${type==='loc'?loc:(type==='done'?'（完成）':'（未完成）')}</div><div style="padding:16px">`;
  if(!arr.length)h+='<div style="text-align:center;color:#999;padding:40px">無資料</div>';
  else{
    const can=user.permission==='全功能';
    arr.forEach(r=>{
      h+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px dashed #eee">
        <div><div style="font-weight:800">${r.d[d.a]||''}</div><div style="font-weight:800">${r.d[d.c]||''}</div></div>
        ${can&&type==='todo'&&step!=='車暫停位置'&&step!=='車停靠位置'?`<button style="background:#1f6fe5;color:#fff;padding:8px 16px;border:none;border-radius:8px" onclick="upd(d.cfg,${r.r},${col+1},new Date().toLocaleTimeString('zh-TW',{hour12:false}))">打卡</button>`:''}
        <button style="background:#fff;color:#1f6fe5;border:1px solid #e2e8f0;padding:8px 16px;border-radius:8px;margin-left:8px" onclick="detail(${r.r})">詳細</button>
      </div>`;
    });
  }
  h+='</div>';
  document.getElementById('content').innerHTML=h;
}

async function upd(cfg,row,col,val){
  await fetch(API+'?action=update',{method:'POST',headers:{'Content-Type':'text/plain;charset=utf-8'},body:JSON.stringify({sheet:cfg.s,idToken:token,writes:[{row:row,col:col,value:val}]})});
  load(1);
}

function detail(r){
  const d=data[key];
  const row=d.rows.find(x=>x.r===r).d;
  let h=`<div style="padding:16px;font-weight:700">詳細資料</div><table style="width:100%;border-collapse:collapse">`;
  d.cfg.steps.forEach(s=>{
    const i=d.head.indexOf(s);
    h+=`<tr><td style="padding:12px;border:1px solid #eee;text-align:left">${s}</td><td style="padding:12px;border:1px solid #eee">${i>=0?row[i]||'':'—'}</td></tr>`;
  });
  h+=`</table><button style="margin:20px 16px 0;width:calc(100%-32px);background:#1f6fe5;color:#fff;padding:14px;border:none;border-radius:12px" onclick="load(1)">返回</button>`;
  document.getElementById('content').innerHTML=h;
}
</script>
</body>
</html>
