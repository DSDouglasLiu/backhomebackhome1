<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>車流退場-手機版</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root{--primary:#1f6fe5;--bg:#f1f5f9;--card:#fff;--text:#0f172a;--sub:#64748b;--border:#e2e8f0;--orange:#f97316;--teal:#059669;--purple:#7c3aed;--pink:#db2777}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,sans-serif;padding:60px 0 50px}
header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:1000}
header button{background:none;border:none;color:#fff;font-size:16px;font-weight:bold;padding:8px}
#tabs{position:sticky;top:60px;background:var(--card);padding:12px 0;overflow-x:auto;white-space:nowrap;z-index:900;-webkit-overflow-scrolling:touch;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
#tabs::-webkit-scrollbar{display:none}
.tab-btn{display:inline-block;margin:0 8px;padding:8px 16px;border-radius:20px;background:var(--bg);font-weight:600;font-size:14px;color:var(--sub);border:1px solid transparent;transition:0.2s}
.tab-btn.active{background:var(--primary);color:#fff}
#content{padding:16px;max-width:640px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.card.orange{border-left:4px solid var(--orange);background:#fff7ed}
.title{font-weight:700;margin-bottom:12px;font-size:16px}
.row{display:flex;gap:12px}
.box{flex:1;background:var(--bg);border-radius:12px;padding:12px;text-align:center;cursor:pointer}
.box:active{transform:scale(.96)}
.num{font-size:28px;font-weight:800}
.done{color:var(--primary)}
.todo{color:#ef4444}
.loc{display:flex;gap:12px;overflow-x:auto;padding:8px 0 16px;-webkit-overflow-scrolling:touch}
.loc>div{min-width:110px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;cursor:pointer}
.loc>div:active{border-color:var(--primary)}
/* 登入畫面 */
#login{position:fixed;inset:0;background:#fff;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;text-align:center}
#login.show{display:flex}
#login.hide{display:none}
#app.hide{display:none}
/* 下方清單 (Bottom Sheet) */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;opacity:0;visibility:hidden;transition:0.3s;backdrop-filter:blur(2px)}
.modal-backdrop.show{opacity:1;visibility:visible}
.bottom-sheet{position:fixed;bottom:0;left:0;right:0;background:#fff;z-index:2001;border-radius:20px 20px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,0.15);transform:translateY(100%);transition:0.3s cubic-bezier(0.2,0.8,0.2,1);max-height:85vh;display:flex;flex-direction:column}
.bottom-sheet.show{transform:translateY(0)}
.sheet-content{overflow-y:auto;padding:0 16px 32px;flex:1}
/* 其他元件 */
#loading{position:fixed;inset:0;background:rgba(255,255,255,.9);z-index:99999;display:none;align-items:center;justify-content:center}
#loading.show{display:flex}
.spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:s 1s linear infinite}
@keyframes s{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:12px 24px;border-radius:30px;z-index:99999;opacity:0;transition:.3s}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-10px)}
.form-select{width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);background:#fff;margin-bottom:8px;font-size:16px}
.btn{border:none;cursor:pointer;font-weight:600}
</style>
</head>
<body>

<div id="login" class="show">
  <h1 style="color:var(--primary);margin-bottom:8px">車流人流退場情報</h1>
  <p style="color:var(--sub);margin-bottom:30px">請登入以瀏覽看板</p>
  <div id="g_id_onload"></div>
</div>

<div id="app" class="hide">
  <header>
    <button id="refresh">Refresh</button>
    <a href="https://dsdouglasliu.github.io/backhomebackhome/" target="_blank" style="color:#fff;font-weight:700;text-decoration:none">網頁版</a>
    <button id="logout">Logout</button>
  </header>
  <div id="tabs"></div>
  <div id="content"></div>
</div>

<div class="modal-backdrop" id="modalBackdrop"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div style="padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
    <div style="font-size:18px;font-weight:700" id="sheetTitle">清單</div>
    <div style="font-size:24px;padding:0 8px;color:#999;cursor:pointer" id="sheetClose">×</div>
  </div>
  <div class="sheet-content" id="sheetBody"></div>
</div>

<div id="loading"><div class="spinner"></div></div>
<div id="toast" class="toast"></div>

<script>
const API_BASE='https://script.google.com/macros/s/AKfycbyet306bK0Tufby0083U05rZS_DwswPD62YQIMIjT154irK_nS1n9Iuf2TEZvnXjmUgGw/exec';
const CLIENT_ID='368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const CONFIG=[
  {k:'地區專車退場（遊覽車平台）',s:'地區專車退場（遊覽車平台）',c:'#059669',steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台搭車','車第二次上遊覽車平台','車已離開遊覽車平台'],sec:['退場人員已到齊','人已前往平台搭車']},
  {k:'地區專車退場（禪堂平台）',s:'地區專車退場（禪堂平台）',c:'#d97706',steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車停靠位置','人已前往禪堂平台搭車','車已離開禪堂平台'],sec:['人已前往禪堂平台搭車','車已離開禪堂平台']},
  {k:'水陸專車退場',s:'水陸專車退場',c:'#7c3aed',steps:['已 Call 車排車隊','已排好車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','人從車庫前往平台搭車','車已離開遊覽車平台'],sec:['退場人員已到齊','人從車庫前往平台搭車']},
  {k:'288法青退場',s:'288法青退場',c:'#db2777',steps:['退場人員已到齊','車已上遊覽車平台','車已離開遊覽車平台'],sec:[]}
];
const STOPS=['P 禪堂平台','P 法心北路','P 法心南路（西）','P 法心南路（東）','P 法大路','P 雙環路至法大一橋'];

let token=localStorage.getItem('t'), user=null, key=CONFIG[0].k, data={};

function $(id){return document.getElementById(id)}
function toast(m,e=0){const t=$('toast');t.textContent=m;t.style.background=e?'#ef4444':'#333';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
function loading(s){s?$('loading').classList.add('show'):$('loading').classList.remove('show')}
function getHHMMSS(){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());}

window.onload = () => {
  // 1. 初始化 Google 登入 (必須最先執行)
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: r => {
      token = r.credential;
      localStorage.setItem('t', token);
      verify(token);
    }
  });

  // 2. 判斷是否已有 Token
  if (token) {
    verify(token);
  } else {
    // 3. 渲染按鈕
    google.accounts.id.renderButton($('g_id_onload'), {
      type: 'standard', size: 'large', theme: 'outline', 
      text: 'signin_with', shape: 'pill', logo_alignment: 'left', width: 250
    });
  }

  $('refresh').onclick = () => load(1);
  $('logout').onclick = () => { localStorage.removeItem('t'); location.reload() };
  $('modalBackdrop').onclick = closeSheet;
  $('sheetClose').onclick = closeSheet;
};

async function verify(t){
  loading(1);
  try{
    const r=await fetch(API_BASE+'?action=verify',{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({idToken:t})});
    const j=await r.json();
    if(j.error)throw j.error;
    user=j;
    $('login').classList.add('hide');
    $('app').classList.remove('hide');
    initTabs();
    load(1);
  }catch(e){
    console.error(e);
    toast('登入失敗',1);
    localStorage.removeItem('t');
    // 如果失敗，重新渲染按鈕
    $('login').classList.remove('hide');
    $('app').classList.add('hide');
    google.accounts.id.renderButton($('g_id_onload'), { type: 'standard', size: 'large' });
  }
  finally{loading(0)}
}

function initTabs(){
  const c=$('tabs');c.innerHTML='';
  CONFIG.forEach(o=>{
    const b=document.createElement('button');
    b.className='tab-btn';b.textContent=o.k;
    if(o.k===key)b.classList.add('active');
    b.onclick=()=>switchTab(o.k);
    c.appendChild(b);
  });
}

function switchTab(k){
  key=k;
  document.documentElement.style.setProperty('--primary',CONFIG.find(o=>o.k===k).c);
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active',b.textContent===k));
  // Scroll tab into view
  const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent === k);
  if(activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
  load(1);
}

async function load(f=0){
  if(f)loading(1);
  const cfg=CONFIG.find(o=>o.k===key);
  try{
    const r=await fetch(`${API_BASE}?action=get&sheet=${encodeURIComponent(cfg.s)}&idToken=${token}`);
    const j=await r.json();
    const d=parse(j.values||[],cfg);
    data[key]=d;
    render(d);
    if(f)toast('已更新');
  }catch(e){toast('載入失敗',1)}
  finally{if(f)loading(0)}
}

function parse(v,cfg){
  if(!v.length)return{rows:[]};
  let h=-1;
  for(let i=0;i<10;i++)if(v[i]&&v[i].join('').includes('車號')){h=i;break;}
  if(h<0)return{rows:[]};
  const head=v[h].map(s=>s.trim());
  const a=head.findIndex(c=>c.includes('區域')||c.includes('編號'));
  const c=head.findIndex(c=>c.includes('車號'));
  const rows=[];
  for(let i=h+1;i<v.length;i++)if(v[i][a]&&v[i][c])rows.push({d:v[i],r:i+1});
  return{head,rows,a,c,cfg};
}

function render(d){
  const c=$('content');c.innerHTML='';
  if(!d.rows.length){c.innerHTML='<div style="text-align:center;padding:50px;color:#999">無資料</div>';return;}
  const {cfg,head,rows,a,c}=d;
  let stopI=cfg.steps.indexOf('車暫停位置');
  if(stopI===-1)stopI=cfg.steps.indexOf('車停靠位置');
  const stopName=stopI>=0?cfg.steps[stopI]:null;
  const inSteps=stopI>=0?cfg.steps.slice(0,stopI):cfg.steps;
  const outSteps=stopI>=0?cfg.steps.slice(stopI+1):[];

  const count=(s)=>{let col=head.indexOf(s),done=0,total=rows.length;
    rows.forEach(r=>{if(col>=0&&r.d[col]&&r.d[col]!=='—')done++});
    return{done,total-done};
  };

  if(inSteps.length){
    c.innerHTML+='<div class="title">進場程序</div>';
    inSteps.forEach(s=>c.appendChild(card(s,count(s),cfg.sec.includes(s))));
  }

  if(stopName){
    const can=user.permission==='全功能';
    const stopCol=head.indexOf(stopName);

    // 登錄區塊
    if(can&&stopI>0){
      const prev=cfg.steps[stopI-1];
      const prevCol=head.indexOf(prev);
      const ready=rows.filter(r=>!r.d[stopCol]||r.d[stopCol]==='—')
                        .filter(r=>prevCol>=0&&r.d[prevCol]&&r.d[prevCol]!=='—');
      if(ready.length){
        let html=`<div class="title">${stopName}登錄</div><select id="loc" class="form-select"><option value="">請選擇位置</option>`;
        STOPS.forEach(o=>html+=`<option>${o}</option>`);
        html+='</select><select id="car" class="form-select"><option value="">請選擇車輛</option>';
        ready.forEach(r=>html+=`<option value="${r.r}">${r.d[a]||''} ${r.d[c]||''}</option>`);
        html+=`</select><button class="btn" style="margin-top:12px;width:100%;background:var(--primary);color:#fff;padding:14px;border-radius:12px;font-size:16px" id="add">確定登錄位置</button>`;
        const div=document.createElement('div');div.className='card';div.innerHTML=html;
        c.appendChild(div);
        
        // 修正：動態綁定 click 事件
        setTimeout(() => {
           const btn = $('add');
           if(btn) btn.onclick=()=>{
               const l=$('loc').value,cr=$('car').value;
               if(l&&cr)update(cfg,parseInt(cr),stopCol+1,l);
           };
        }, 100);
      }
    }

    // 位置卡片
    const loc=document.createElement('div');loc.className='loc';
    const cnt={};STOPS.forEach(o=>cnt[o]=0);
    rows.forEach(r=>{const v=r.d[stopCol]?r.d[stopCol].trim():'';if(STOPS.includes(v))cnt[v]++;});
    STOPS.forEach(o=>{
      const b=document.createElement('div');
      b.innerHTML=`<div style="font-size:13px;color:var(--sub);margin-bottom:4px">${o}</div><div style="font-size:26px;font-weight:800;color:var(--primary)">${cnt[o]}</div>`;
      b.onclick=()=>list(stopName,'loc',o);
      loc.appendChild(b);
    });
    c.appendChild(loc);
  }

  if(outSteps.length){
    c.innerHTML+='<div class="title" style="margin-top:24px">退場程序</div>';
    outSteps.forEach(s=>c.appendChild(card(s,count(s),cfg.sec.includes(s))));
  }
}

function card(title,nums,sec){
  const d=document.createElement('div');
  d.className=sec?'card orange':'card';
  d.innerHTML=`
    <div class="title">${title}</div>
    <div class="row">
      <div class="box" onclick="list('${title}','done')"><div class="num done">${nums.done}</div><div>完成</div></div>
      <div class="box" onclick="list('${title}','todo')"><div class="num todo">${nums.total-nums.done}</div><div>未完成</div></div>
    </div>`;
  return d;
}

function list(step,type,loc=''){
  const d=data[key];
  if(!d)return;
  const col=d.head.indexOf(step);
  const arr=[];
  d.rows.forEach(r=>{
    const v=col>=0?r.d[col]?r.d[col].trim():'' :'';
    const done=v&&v!=='—';
    if(type==='loc'&&v===loc)arr.push(r);
    else if(type==='done'&&done)arr.push(r);
    else if(type==='todo'&&!done)arr.push(r);
  });
  
  $('sheetTitle').textContent = `${step} ${type==='loc'?loc:(type==='done'?'(完成)':'(未完成)')}`;
  
  let html='';
  if(!arr.length)html='<div style="text-align:center;color:#999;padding:40px">無資料</div>';
  else{
    const can=user.permission==='全功能';
    arr.forEach(r=>{
      const area=r.d[d.a]||'',car=r.d[d.c]||'';
      html+=`<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px dashed #ddd">
        <div><div style="font-weight:800">${area}</div><div style="font-weight:800">${car}</div></div>`;
      
      // 修正打卡按鈕邏輯
      if(can&&type==='todo'&&step!=='車暫停位置'&&step!=='車停靠位置'){
        const si=d.cfg.steps.indexOf(step);
        const prev=si>0?d.cfg.steps[si-1]:null;
        const pc=prev?d.head.indexOf(prev):-1;
        const ok=!prev||(pc>=0&&r.d[pc]&&r.d[pc]!=='—');
        
        // 修正：使用 onclick 呼叫包裝函式，傳遞字串參數要加引號
        if(ok) {
            html+=`<button class="btn" style="background:var(--primary);color:#fff;padding:8px 16px;border-radius:8px" onclick="handlePunch(${r.r},${col+1})">打卡</button>`;
        } else {
            html+=`<button class="btn" style="background:#ccc;color:#fff;padding:8px 16px;border-radius:8px" disabled>打卡</button>`;
        }
      }
      html+=`<button class="btn" style="background:#fff;color:var(--primary);border:1px solid var(--border);padding:8px 16px;border-radius:8px;margin-left:8px" onclick="detail(${r.r})">詳細</button></div>`;
    });
  }
  
  $('sheetBody').innerHTML=html;
  $('modalBackdrop').classList.add('show');
  $('bottomSheet').classList.add('show');
}

// 代理打卡函式 (解決 HTML onclick 傳遞物件問題)
function handlePunch(row, col) {
    const cfg = CONFIG.find(o => o.k === key);
    update(cfg, row, col, getHHMMSS());
}

function closeSheet(){
    $('modalBackdrop').classList.remove('show');
    $('bottomSheet').classList.remove('show');
}

async function update(cfg,row,col,val){
  loading(1);
  try{
    await fetch(API_BASE+'?action=update',{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify({sheet:cfg.s,idToken:token,writes:[{row:row,col:col,value:val}]})
    });
    load(1);
    toast('更新成功');
    closeSheet(); // 成功後關閉視窗
  }catch(e){toast('失敗',1)}
  finally{loading(0)}
}

function detail(r){
  const d=data[key];
  const row=d.rows.find(x=>x.r===r).d;
  let h=`<div style="padding:16px;font-weight:700">詳細資料</div><table style="width:100%;border-collapse:collapse;font-size:14px">`;
  d.cfg.steps.forEach(s=>{
    const i=d.head.indexOf(s);
    h+=`<tr><td style="padding:10px;border:1px solid var(--border);text-align:left">${s}</td><td style="padding:10px;border:1px solid var(--border)">${i>=0?row[i]||'':'—'}</td></tr>`;
  });
  h+=`</table><button class="btn" style="margin:20px 16px 0;width:calc(100% - 32px);background:var(--primary);color:#fff;padding:14px;border-radius:12px" onclick="closeSheet()">關閉</button>`;
  $('sheetBody').innerHTML=h;
}
</script>
</body>
</html>
