<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>車流退場-手機版</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root {
  --primary-base: #1f6fe5;
  --theme-color: #1f6fe5;
  --bg-body: #f1f5f9;
  --surface: #ffffff;
  --text-main: #0f172a;
  --text-sub: #64748b;
  --border: #e2e8f0;
  --radius-lg: 16px;
  --radius-md: 12px;
  --radius-sm: 8px;
  --c-teal: #059669;
  --c-orange: #f97316;
  --c-purple: #7c3aed;
  --c-pink: #db2777;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  background: var(--bg-body); color: var(--text-main);
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  padding-top: 60px; padding-bottom: 40px;
}
.header {
  position: fixed; top: 0; left: 0; right: 0;
  height: 60px; background-color: var(--theme-color); color: #fff;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 16px; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.header-btn {
  background: transparent; border: none; color: #fff;
  padding: 10px; border-radius: 50%; cursor: pointer;
}
.header-btn:active { background: rgba(255,255,255,0.2); }
.header-link {
  font-size: 18px; font-weight: 700; color: #fff; text-decoration: none;
  padding: 8px 16px; border-radius: 20px; background: rgba(0,0,0,0.1);
}
.header-link:active { background: rgba(0,0,0,0.2); }
.tabs-wrapper {
  background: var(--surface); position: sticky; top: 60px; z-index: 900;
  box-shadow: var(--shadow-sm); padding: 12px 0; overflow-x: auto;
  white-space: nowrap; -webkit-overflow-scrolling: touch;
}
.tabs-wrapper::-webkit-scrollbar { display: none; }
.tab-btn {
  display: inline-block; margin: 0 6px; padding: 8px 16px;
  border-radius: 20px; font-size: 14px; font-weight: 600;
  color: var(--text-sub); background: var(--bg-body);
  border: 1px solid transparent; transition: all 0.2s;
}
.tab-btn:first-child { margin-left: 16px; }
.tab-btn:last-child { margin-right: 16px; }
.tab-btn.active {
  background: var(--theme-color); color: #fff;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}
.content { padding: 16px; max-width: 600px; margin: 0 auto; }
.section-title {
  font-size: 14px; font-weight: 600; color: var(--text-sub);
  margin: 24px 0 8px 4px; display: flex; align-items: center; gap: 6px;
}
.section-title::before { content:''; width:4px; height:14px; background:var(--theme-color); border-radius:2px; display:block; }
.stat-card {
  background: var(--surface); border-radius: var(--radius-lg);
  padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow-sm);
  border: 1px solid var(--border); transition: all 0.2s;
}
.stat-card.secondary {
  border: 2px solid var(--c-orange); background-color: #fff7ed;
}
.stat-card.secondary .step-header { color: #c2410c; }
.step-header { font-size: 16px; font-weight: 700; margin-bottom: 12px; }
.stat-row { display: flex; gap: 12px; }
.stat-box {
  flex: 1; text-align: center; background: var(--bg-body);
  border-radius: var(--radius-md); padding: 14px 8px; cursor: pointer;
}
.stat-box:active { transform: scale(0.96); background: #e2e8f0; }
.stat-card.secondary .stat-box { background: #ffffff; border: 1px solid rgba(249,115,22,0.2); }
.stat-num { font-size: 28px; font-weight: 800; }
.stat-label { font-size: 12px; color: var(--text-sub); margin-top: 4px; }
.num-done { color: var(--theme-color); }
.num-todo { color: #ef4444; }
.loc-scroll {
  display: flex; gap: 12px; overflow-x: auto; padding: 8px 0 16px;
  -webkit-overflow-scrolling: touch;
}
.loc-card {
  min-width: 110px; flex-shrink: 0; background: var(--surface);
  border: 1px solid var(--border); border-radius: var(--radius-md);
  padding: 14px; text-align: center; cursor: pointer;
}
.loc-card:active { border-color: var(--theme-color); transform: scale(0.96); }
.loc-name { font-size: 13.5px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; }
.loc-val { font-size: 26px; font-weight: 800; color: var(--theme-color); }
.parking-input-group {
  background: var(--surface); border-radius: var(--radius-lg);
  padding: 16px; margin-bottom: 16px; box-shadow: var(--shadow-sm);
  border: 1px solid var(--border);
}
.form-label { font-size: 14px; font-weight:600; color:var(--text-sub); margin:8px 0 4px; }
.form-select {
  width: 100%; padding: 14px; border-radius: var(--radius-md);
  border: 1px solid var(--border); background: #fff; font-size: 16px;
  appearance: none;
  background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2364748b%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
  background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 12px;
}
.form-select:disabled {
  background-color: #f8f9fa; opacity: 0.5; cursor: not-allowed;
}
#login-view {
  display: none; position: fixed; inset: 0; background: #fff; z-index: 2000;
  flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
}
#login-view.show { display: flex; }
.login-title { font-size: 24px; font-weight: 800; color: var(--primary-base); margin-bottom: 12px; }
.login-sub { color: var(--text-sub); margin-bottom: 32px; }
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000;
 opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(2px);
}
.modal-backdrop.show { opacity: 1; visibility: visible; }
.bottom-sheet {
  position: fixed; bottom: 0; left: 0; right: 0; background: #fff; z-index: 2001;
  border-radius: 20px 20px 0 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
  transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2,0.8,0.2,1);
  max-height: 85vh; display: flex; flex-direction: column;
}
.bottom-sheet.show { transform: translateY(0); }
.sheet-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.sheet-title { font-size: 18px; font-weight: 700; }
.sheet-close { font-size: 28px; padding: 8px; color: var(--text-sub); cursor: pointer; }
.sheet-content { overflow-y: auto; padding: 0 16px 32px; flex: 1; }
.list-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 16px 0; border-bottom: 1px dashed var(--border);
}
.item-info { display: flex; align-items: center; gap: 12px; flex: 1; }
.item-text { font-size: 18px; font-weight: 800; color: var(--text-main); }
.btn {
  border: none; border-radius: 50px; padding: 10px 20px;
  font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s;
  white-space: nowrap; display: inline-flex; align-items: center; justify-content: center;
}
.btn-primary { background: var(--theme-color); color: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
.btn-primary:active { transform: translateY(1px); filter: brightness(0.9); }
.btn-outline { background: #fff; border: 1px solid var(--border); color: var(--text-sub); }
#loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 3000;
  display: none; align-items: center; justify-content: center; }
#loading.show { display: flex; }
.spinner { width: 40px; height: 40px; border: 4px solid var(--border);
  border-top-color: var(--theme-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin{ to{ transform: rotate(360deg); } }
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: #334155; color: #fff; padding: 10px 20px; border-radius: 50px;
  font-size: 14px; opacity: 0; z-index: 4000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  transition: 0.3s; white-space: nowrap;
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
.detail-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
.detail-table th, .detail-table td { padding: 10px; border: 1px solid var(--border); text-align: center; }
.detail-table th { background: var(--bg-body); color: var(--text-sub); }
</style>
</head>
<body>
<div id="login-view" class="show">
  <div class="login-title">車流人流退場情報</div>
  <div class="login-sub">請登入以瀏覽看板</div>
  <div id="signin-btn"></div>
</div>

<div id="app-view" style="display:none;">
  <header class="header">
    <button class="header-btn" id="btnRefresh" title="更新">
      <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-8 3.58-8 8s3.58 8 8 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
    </button>
    <a href="https://dsdouglasliu.github.io/backhomebackhome/" target="_blank" class="header-link">網頁版</a>
    <button class="header-btn" id="btnLogout" title="登出">
      <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
    </button>
  </header>
  <div class="tabs-wrapper" id="tabsContainer"></div>
  <div class="content" id="dashboardContent"></div>
</div>

<div class="modal-backdrop" id="modalBackdrop"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-header">
    <div class="sheet-title" id="sheetTitle">清單</div>
    <div class="sheet-close" id="sheetClose">×</div>
  </div>
  <div class="sheet-content" id="sheetBody"></div>
</div>

<div id="loading"><div class="spinner"></div></div>
<div id="toast" class="toast">已更新</div>

<script>
/* ============ CONFIG ============ */
const API_BASE = 'https://script.google.com/macros/s/AKfycbyet306bK0Tufby0083U05rZS_DwswPD62YQIMIjT154irK_nS1n9Iuf2TEZvnXjmUgGw/exec';
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';
const SHEET_CONFIGS = [
  { key:'地區專車退場（遊覽車平台）', sheet:'地區專車退場（遊覽車平台）', color: '#059669',
    steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台搭車','車第二次上遊覽車平台','車已離開遊覽車平台'],
    secondarySteps: ['退場人員已到齊','人已前往平台搭車'] },
  { key:'地區專車退場（禪堂平台）', sheet:'地區專車退場（禪堂平台）', color: '#d97706',
    steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車停靠位置','人已前往禪堂平台搭車','車已離開禪堂平台'],
    secondarySteps: ['人已前往禪堂平台搭車','車已離開禪堂平台'] },
  { key:'水陸專車退場', sheet:'水陸專車退場', color: '#7c3aed',
    steps:['已 Call 車排車隊','已排好車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','人從車庫前往平台搭車','車已離開遊覽車平台'],
    secondarySteps: ['退場人員已到齊','人從車庫前往平台搭車'] },
  { key:'288法青退場', sheet:'288法青退場', color: '#db2777',
    steps:['退場人員已到齊','車已上遊覽車平台','車已離開遊覽車平台'], secondarySteps: [] }
];
const STOP_OPTIONS = ['P 禪堂平台','P 法心北路','P 法心南路（西）','P 法心南路（東）','P 法大路','P 雙環路至法大一橋'];
const REFRESH_MS = 60000;

let idToken = localStorage.getItem('ddcc_user_token');
let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let refreshTimer = null;
let SHEET_DATA = {};

/* ============ UTILS ============ */
function normalize(str) { return String(str || '').trim().replace(/\s+/g, ' '); }
function getHHMMSS() {
  return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());
}

/* ============ AUTH & INIT ============ */
window.onload = function() {
  if (idToken) { showLoading(); verifyToken(idToken); }
  else { initGoogleBtn(); }

  document.getElementById('btnRefresh').onclick = () => loadDashboard(true);
  document.getElementById('btnLogout').onclick = logout;
  document.getElementById('modalBackdrop').onclick = closeSheet;
  document.getElementById('sheetClose').onclick = closeSheet;
};

function initGoogleBtn() {
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: r => {
      idToken = r.credential;
      localStorage.setItem('ddcc_user_token', idToken);
      showLoading();
      verifyToken(idToken);
    }
  });
  google.accounts.id.renderButton(document.getElementById('signin-btn'), { theme: 'outline', size: 'large', shape: 'pill', width: 250 });
}

async function verifyToken(token) {
  try {
    const response = await fetch(API_BASE + '?action=verify', {
      method: 'POST',
      headers: {
        'Content-Type': 'text/plain;charset=utf-8'  // 這行！！
      },
      body: JSON.stringify({ idToken: token })
    });

    const text = await response.text();
    let j;
    try {
      j = JSON.parse(text);
    } catch(e) {
      console.error('後端回傳非 JSON:', text);
      throw new Error('伺服器回應異常');
    }

    if (j.error) throw new Error(j.error);

    currentUser = j;
    document.getElementById('login-view').classList.remove('show');
    document.getElementById('app-view').style.display = 'block';

    initTabs();
    switchTab(currentSheetKey);
    startAutoRefresh();

    showToast('歡迎回來，' + (j.name || '使用者'));
  } catch (err) {
    console.error('驗證失敗:', err);
    showToast('登入失敗，請再試一次', true);
    logout();
  } finally {
    hideLoading();
  }
}

function logout() {
  localStorage.removeItem('ddcc_user_token');
  location.reload();
}

function startAutoRefresh() {
  clearInterval(refreshTimer);
  refreshTimer = setInterval(() => loadDashboard(true, true), REFRESH_MS);
}

/* ============ DATA & RENDER ============ */
async function loadDashboard(force = false, silent = false) {
  if (!currentUser) return;
  if (force && !silent) showLoading();

  const cfg = SHEET_CONFIGS.find(s => s.key === currentSheetKey);
  try {
    const r = await fetch(`${API_BASE}?action=get&sheet=${encodeURIComponent(cfg.sheet)}&idToken=${idToken}`);
    const j = await r.json();
    const parsed = parseData(j.values || [], cfg);
    SHEET_DATA[currentSheetKey] = parsed;
    renderDashboard(parsed);
    if (force) showToast('已更新');
  } catch(e) {
    showToast('更新失敗', true);
  } finally {
    if (force && !silent) hideLoading();
  }
}

function parseData(values, cfg) {
  if (!values.length) return { header:[], rows:[], cfg };

  let headIdx = -1;
  for (let i = 0; i < Math.min(values.length, 10); i++) {
    if (values[i].join(' ').toLowerCase().includes('車號') || values[i].join(' ').includes('編號')) { headIdx = i; break; }
  }
  if (headIdx === -1) return { header:[], rows:[], cfg };

  const header = values[headIdx].map(s => String(s).trim());

  const areaIdx = header.findIndex(c => c.includes('區域') || c.includes('編號'));
  const carIdx = header.findIndex(c => c.includes('車號'));

  const rows = [];
  for (let i = headIdx + 1; i < values.length; i++) {
    const row = values[i];
    if (row[areaIdx] && row[carIdx]) {
      rows.push({ data: row, rowIndex: i + 1 });
    }
  }
  return { header, rows, cfg, areaIdx, carIdx };
}

function renderDashboard(data) {
  const container = document.getElementById('dashboardContent');
  container.innerHTML = '';

  if (!data || !data.rows.length) {
    container.innerHTML = '<div style="text-align:center;color:#999;margin-top:40px;">無資料</div>';
    return;
  }

  const { cfg, header, rows, areaIdx, carIdx } = data;

  // 動態找出停車欄位名稱（支援 車暫停位置 或 車停靠位置）
  let stopIdx = cfg.steps.indexOf('車暫停位置');
  if (stopIdx === -1) stopIdx = cfg.steps.indexOf('車停靠位置');
  const actualStopField = stopIdx >= 0 ? cfg.steps[stopIdx] : null;

  const inbound = stopIdx >= 0 ? cfg.steps.slice(0, stopIdx) : cfg.steps;
  const outbound = stopIdx >= 0 ? cfg.steps.slice(stopIdx + 1) : [];

  const getCounts = (step) => {
    const col = header.indexOf(step);
    let done = 0, todo = 0;
    rows.forEach(r => {
      const v = col >= 0 ? String(r.data[col] || '').trim() : '';
      (v && v !== '—') ? done++ : todo++;
    });
    return { done, todo };
  };

  // 進場
  if (inbound.length) {
    container.innerHTML += `<div class="section-title">進場程序</div>`;
    inbound.forEach(step => {
      const isSec = cfg.secondarySteps.includes(step);
      container.appendChild(createStatCard(step, getCounts(step), isSec));
    });
  }

  // 停車位置區塊
  if (actualStopField) {
    const canWrite = currentUser.permission === '全功能';
    const stopCol = header.indexOf(actualStopField);

    // 可登錄區塊
    if (canWrite && stopIdx > 0) {
      const prevStep = cfg.steps[stopIdx - 1];
      const prevCol = header.indexOf(prevStep);

      const eligibleCars = rows.filter(r => {
        const stopVal = stopCol >= 0 ? String(r.data[stopCol] || '').trim() : '';
        const prevVal = prevCol >= 0 ? String(r.data[prevCol] || '').trim() : '';
        return (!stopVal || stopVal === '—') && prevVal && prevVal !== '—';
      });

      if (eligibleCars.length > 0) {
        const div = document.createElement('div');
        div.className = 'parking-input-group';
        let locOpts = '<option value="" disabled selected>請選擇位置</option>';
        STOP_OPTIONS.forEach(o => locOpts += `<option value="${o}">${o}</option>`);
        let carOpts = '<option value="" disabled selected>請選擇車輛</option>';
        eligibleCars.forEach(r => {
          const area = r.data[areaIdx] || '';
          const carNo = r.data[carIdx] || '';
          carOpts += `<option value="${r.rowIndex}">${area} ${carNo}</option>`;
        });

        div.innerHTML = `
          <div class="step-header">${actualStopField}登錄</div>
          <div class="form-label">選擇位置</div>
          <select id="selParkLoc" class="form-select">${locOpts}</select>
          <div class="form-label" id="lblAddCar">新增車輛</div>
          <select id="selParkCar" class="form-select">${carOpts}</select>
          <button class="btn btn-primary" id="btnParkSubmit" style="width:100%;margin-top:12px">確定登錄</button>
        `;
        container.appendChild(div);

        setTimeout(() => {
          document.getElementById('btnParkSubmit').onclick = () => {
            const loc = document.getElementById('selParkLoc').value;
            const carRow = document.getElementById('selParkCar').value;
            if (!loc || !carRow) return showToast('請選擇位置與車輛', true);
            doUpdate(cfg, parseInt(carRow), stopCol + 1, loc);
          };
          document.getElementById('selParkLoc').onchange = () => {
            const lbl = document.getElementById('lblAddCar');
            if (lbl) lbl.textContent = document.getElementById('selParkLoc').value ? `新增車輛至 ${document.getElementById('selParkLoc').value}` : '新增車輛';
          };
        }, 100);
      }
    }

    // 位置卡片
    const scroll = document.createElement('div');
    scroll.className = 'loc-scroll';
    const counts = {};
    STOP_OPTIONS.forEach(op => counts[op] = 0);
    rows.forEach(r => {
      const v = stopCol >= 0 ? String(r.data[stopCol] || '').trim() : '';
      if (STOP_OPTIONS.includes(v)) counts[v]++;
    });
    STOP_OPTIONS.forEach(op => {
      const card = document.createElement('div');
      card.className = 'loc-card';
      card.onclick = () => openList(currentSheetKey, actualStopField, 'loc', op);
      card.innerHTML = `<div class="loc-name">${op}</div><div class="loc-val">${counts[op]}</div>`;
      scroll.appendChild(card);
    });
    container.appendChild(scroll);
  }

  // 退場
  if (outbound.length) {
    container.innerHTML += `<div class="section-title" style="margin-top:24px">退場程序</div>`;
    outbound.forEach(step => {
      const isSec = cfg.secondarySteps.includes(step);
      container.appendChild(createStatCard(step, getCounts(step), isSec));
    });
  }
}

function createStatCard(step, counts, isSecondary) {
  const div = document.createElement('div');
  div.className = isSecondary ? 'stat-card secondary' : 'stat-card';
  div.innerHTML = `
    <div class="step-header">${step}</div>
    <div class="stat-row">
      <div class="stat-box" onclick="openList('${currentSheetKey}', '${step}', 'done')">
        <div class="stat-num num-done">${counts.done}</div>
        <div class="stat-label">完成</div>
      </div>
      <div class="stat-box" onclick="openList('${currentSheetKey}', '${step}', 'todo')">
        <div class="stat-num num-todo">${counts.todo}</div>
        <div class="stat-label">未完成</div>
      </div>
    </div>
  `;
  return div;
}

function openList(sheetKey, step, type, locVal = '') {
  const data = SHEET_DATA[sheetKey];
  if (!data) return;

  const { cfg, header, rows, areaIdx, carIdx } = data;
  const colIdx = header.indexOf(step);
  const list = [];

  rows.forEach(r => {
    const val = colIdx >= 0 ? String(r.data[colIdx] || '').trim() : '';
    const isDone = val && val !== '—';
    if (type === 'loc' && val === locVal) list.push(r);
    else if (type === 'done' && isDone) list.push(r);
    else if (type === 'todo' && !isDone) list.push(r);
  });

  document.getElementById('sheetTitle').textContent = `${step} ${type==='loc'?locVal : (type==='done'?'（完成）':'（未完成）')}`;

  const body = document.getElementById('sheetBody');
  body.innerHTML = '';

  if (!list.length) {
    body.innerHTML = '<div style="text-align:center;padding:40px;color:#999">無資料</div>';
  } else {
    const canWrite = currentUser.permission === '全功能';
    list.forEach(r => {
      const area = r.data[areaIdx] || '';
      const car = r.data[carIdx] || '';
      const el = document.createElement('div');
      el.className = 'list-item';
      el.innerHTML = `
        <div class="item-info">
          <div class="item-text">${area}</div>
          <div class="item-text">${car}</div>
        </div>
      `;
      const btns = document.createElement('div');
      btns.style = 'display:flex;gap:8px';

      if (type === 'todo' && step !== '車暫停位置' && step !== '車停靠位置' && canWrite) {
        const stepIdx = cfg.steps.indexOf(step);
        const prevStep = stepIdx > 0 ? cfg.steps[stepIdx-1] : null;
        const prevCol = prevStep ? header.indexOf(prevStep) : -1;
        const prevDone = !prevStep || (prevCol >= 0 && r.data[prevCol]);

        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.textContent = '打卡';
        if (!prevDone) {
          btn.disabled = true; btn.style.opacity = '0.5'; btn.title = '前一步驟未完成';
        } else {
          btn.onclick = () => doUpdate(cfg, r.rowIndex, colIdx + 1, getHHMMSS());
        }
        btns.appendChild(btn);
      }

      const btnDetail = document.createElement('button');
      btnDetail.className = 'btn btn-outline';
      btnDetail.textContent = '詳細';
      btnDetail.onclick = () => showDetail(cfg, r.data, header);
      btns.appendChild(btnDetail);

      el.appendChild(btns);
      body.appendChild(el);
    });
  }

  document.getElementById('modalBackdrop').classList.add('show');
  document.getElementById('bottomSheet').classList.add('show');
}

function closeSheet() {
  document.getElementById('modalBackdrop').classList.remove('show');
  document.getElementById('bottomSheet').classList.remove('show');
}

function showDetail(cfg, row, header) {
  const area = row[header.findIndex(c => c.includes('區域') || c.includes('編號'))] || '';
  const car = row[header.findIndex(c => c.includes('車號'))] || '';
  document.getElementById('sheetTitle').textContent = `${area} ${car}`;

  let html = `<table class="detail-table">`;
  cfg.steps.forEach(st => {
    const idx = header.indexOf(st);
    html += `<tr><th>${st}</th><td>${row[idx] || ''}</td></tr>`;
  });
  html += `</table>`;

  const back = document.createElement('div');
  back.style.padding = '20px 0';
  back.innerHTML = `<button class="btn btn-outline" style="width:100%" onclick="closeSheet()">關閉</button>`;

  const body = document.getElementById('sheetBody');
  body.innerHTML = html;
  body.appendChild(back);
}

function showLoading() { document.getElementById('loading').classList.add('show'); }
function hideLoading() { document.getElementById('loading').classList.remove('show'); }
function showToast(msg, isErr = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = isErr ? '#ef4444' : '#334155';
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}
</script>
</body>
</html>
