<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>車流退場-手機版</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
:root {
  --primary-base: #1f6fe5; --theme-color:#1f6fe5; --bg-body:#f1f5f9; --surface:#ffffff;
  --text-main:#0f172a; --text-sub:#64748b; --border:#e2e8f0;
  --radius-lg:16px; --radius-md:12px;
  --c-teal:#059669; --c-orange:#f97316; --c-purple:#7c3aed; --c-pink:#db2777;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;padding:60px 0 40px;background:var(--bg-body);color:var(--text-main);font-family:system-ui,-apple-system,sans-serif;}
.header{position:fixed;top:0;left:0;right:0;height:60px;background:var(--theme-color);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:1000;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.header-btn{background:transparent;border:none;color:#fff;padding:10px;border-radius:50%;cursor:pointer;}
.header-btn:active{background:rgba(255,255,255,0.2);}
.header-link{font-size:18px;font-weight:700;color:#fff;text-decoration:none;padding:8px 16px;border-radius:20px;background:rgba(0,0,0,0.1);}
.tabs-wrapper{background:var(--surface);position:sticky;top:60px;z-index:900;padding:12px 0;overflow-x:auto;white-space:nowrap;box-shadow:0 1px 2px rgba(0,0,0,0.05);}
.tab-btn{display:inline-block;margin:0 6px;padding:8px 16px;border-radius:20px;font-size:14px;font-weight:600;color:var(--text-sub);background:var(--bg-body);transition:0.2s;}
.tab-btn.active{background:var(--theme-color);color:#fff;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);}
.content{padding:16px;max-width:600px;margin:0 auto;}
.section-title{font-size:14px;font-weight:600;color:var(--text-sub);margin:24px 0 8px 4px;display:flex;align-items:center;gap:6px;}
.section-title::before{content:'';width:4px;height:14px;background:var(--theme-color);border-radius:2px;display:block;}
.stat-card{background:var(--surface);border-radius:var(--radius-lg);padding:16px;margin-bottom:12px;box-shadow:0 1px 2px rgba(0,0,0,0.05);border:1px solid var(--border);}
.stat-card.secondary{border:2px solid var(--c-orange);background:#fff7ed;}
.stat-card.secondary .step-header{color:#c2410c;}
.step-header{font-size:16px;font-weight:700;margin-bottom:12px;}
.stat-row{display:flex;gap:12px;}
.stat-box{flex:1;text-align:center;background:var(--bg-body);border-radius:var(--radius-md);padding:14px 8px;cursor:pointer;}
.stat-box:active{transform:scale(0.96);background:#e2e8f0;}
.stat-num{font-size:28px;font-weight:800;}
.stat-label{font-size:12px;color:var(--text-sub);margin-top:4px;}
.num-done{color:var(--theme-color);}
.num-todo{color:#ef4444;}
.loc-scroll{display:flex;gap:12px;overflow-x:auto;padding:8px 0 16px;-webkit-overflow-scrolling:touch;}
.loc-card{min-width:110px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px;text-align:center;cursor:pointer;}
.loc-card:active{border-color:var(--theme-color);transform:scale(0.96);}
.loc-name{font-size:13.5px;font-weight:700;color:var(--text-sub);margin-bottom:6px;}
.loc-val{font-size:26px;font-weight:800;color:var(--theme-color);}
.parking-input-group{background:var(--surface);border-radius:var(--radius-lg);padding:16px;margin-bottom:16px;box-shadow:0 1px 2px rgba(0,0,0,0.05);border:1px solid var(--border);}
.form-label{font-size:14px;font-weight:600;color:var(--text-sub);margin:8px 0 4px;}
.form-select{width:100%;padding:14px;border-radius:var(--radius-md);border:1px solid var(--border);background:#fff;font-size:16px;appearance:none;background-image:url("data:image/svg+xml;charset=US-ASCII,%3Csvg xmlns='http://www.w3.org/2000/svg' width='292.4' height='292.4'%3E%3Cpath fill='%2364748b' d='M287 69.4a17.6 17.6 0 0 0-13-5.4H18.4c-5 0-9.3 1.8-12.9 5.4A17.6 17.6 0 0 0 0 82.2c0 5 1.8 9.3 5.4 12.9l128 127.9c3.6 3.6 7.8 5.4 12.8 5.4s9.2-1.8 12.8-5.4L287 95c3.5-3.5 5.4-7.8 5.4-12.8 0-5-1.9-9.2-5.5-12.8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px top 50%;background-size:12px;}
.form-select:disabled{opacity:0.5;background:#f8f9fa;cursor:not-allowed;}
#login-view{display:none;position:fixed;inset:0;background:#fff;z-index:2000;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:20px;}
#login-view.show{display:flex;}
.login-title{font-size:24px;font-weight:800;color:var(--primary-base);margin-bottom:12px;}
.login-sub{color:var(--text-sub);margin-bottom:32px;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:2000;opacity:0;visibility:hidden;transition:0.3s;backdrop-filter:blur(2px);}
.modal-backdrop.show{opacity:1;visibility:visible;}
.bottom-sheet{position:fixed;bottom:0;left:0;right:0;background:#fff;z-index:2001;border-radius:20px 20px 0 0;box-shadow:0 -4px 20px rgba(0,0,0,0.15);transform:translateY(100%);transition:0.3s cubic-bezier(0.2,0.8,0.2,1);max-height:85vh;display:flex;flex-direction:column;}
.bottom-sheet.show{transform:translateY(0);}
.sheet-header{padding:16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
.sheet-title{font-size:18px;font-weight:700;}
.sheet-close{font-size:28px;padding:8px;color:var(--text-sub);cursor:pointer;}
.sheet-content{overflow-y:auto;padding:0 16px 32px;flex:1;}
.list-item{display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px dashed var(--border);}
.item-info{display:flex;align-items:center;gap:12px;flex:1;}
.item-text{font-size:18px;font-weight:800;color:var(--text-main);}
.btn{border:none;border-radius:50px;padding:10px 20px;font-size:15px;font-weight:600;cursor:pointer;transition:0.2s;display:inline-flex;align-items:center;justify-content:center;}
.btn-primary{background:var(--theme-color);color:#fff;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
.btn-primary:active{transform:translateY(1px);filter:brightness(0.9);}
.btn-outline{background:#fff;border:1px solid var(--border);color:var(--text-sub);}
#loading{position:fixed;inset:0;background:rgba(255,255,255,0.8);z-index:3000;display:none;align-items:center;justify-content:center;}
#loading.show{display:flex;}
.spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--theme-color);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(20px);background:#334155;color:#fff;padding:10px 20px;border-radius:50px;font-size:14px;opacity:0;z-index:4000;box-shadow:0 4px 12px rgba(0,0,0,0.2);transition:0.3s;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.detail-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px;}
.detail-table th,.detail-table td{padding:10px;border:1px solid var(--border);text-align:center;}
.detail-table th{background:var(--bg-body);color:var(--text-sub);}
</style>
</head>
<body>

<div id="login-view" class="show">
  <div class="login-title">車流人流退場情報</div>
  <div class="login-sub">請登入以瀏覽看板</div>
  <div id="signin-btn" style="display:flex;justify-content:center;margin-top:20px;"></div>
</div>

<div id="app-view" style="display:none;">
  <header class="header">
    <button class="header-btn" id="btnRefresh">Refresh</button>
    <a href="https://dsdouglasliu.github.io/backhomebackhome/" target="_blank" class="header-link">網頁版</a>
    <button class="header-btn" id="btnLogout">Logout</button>
  </header>
  <div class="tabs-wrapper" id="tabsContainer"></div>
  <div class="content" id="dashboardContent"></div>
</div>

<div class="modal-backdrop" id="modalBackdrop"></div>
<div class="bottom-sheet" id="bottomSheet">
  <div class="sheet-header">
    <div class="sheet-title" id="sheetTitle">清單</div>
    <div class="sheet-close" id="sheetClose">×</div>
  </div>
  <div class="sheet-content" id="sheetBody"></div>
</div>

<div id="loading"><div class="spinner"></div></div>
<div id="toast" class="toast">已更新</div>

<script>
/* ============ 正確的後端網址（電腦版正在用的） ============ */
const API_BASE = 'https://script.google.com/macros/s/AKfycbyet306bK0Tufby0083U05rZS_DwswPD62YQIMIjT154irK_nS1n9Iuf2TEZvnXjmUgGw/exec';
const GOOGLE_CLIENT_ID = '368914333961-b8j4o6h73hurdoq5k377f6v2e1pg0r3p.apps.googleusercontent.com';

const SHEET_CONFIGS = [
  {key:'地區專車退場（遊覽車平台）',sheet:'地區專車退場（遊覽車平台）',color:'#059669',
   steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','人已前往平台搭車','車第二次上遊覽車平台','車已離開遊覽車平台'],
   secondarySteps:['退場人員已到齊','人已前往平台搭車']},
  {key:'地區專車退場（禪堂平台）',sheet:'地區專車退場（禪堂平台）',color:'#d97706',
   steps:['車長通知行李到齊','Call 車上行李','車已上遊覽車平台','車前往排車隊','車停靠位置','人已前往禪堂平台搭車','車已離開禪堂平台'],
   secondarySteps:['人已前往禪堂平台搭車','車已離開禪堂平台']},
  {key:'水陸專車退場',sheet:'水陸專車退場',color:'#7c3aed',
   steps:['已 Call 車排車隊','已排好車隊','車暫停位置','退場人員已到齊','已 Call 車上遊覽車平台','車已上遊覽車平台','人從車庫前往平台搭車','車已離開遊覽車平台'],
   secondarySteps:['退場人員已到齊','人從車庫前往平台搭車']},
  {key:'288法青退場',sheet:'288法青退場',color:'#db2777',
   steps:['退場人員已到齊','車已上遊覽車平台','車已離開遊覽車平台'],secondarySteps:[]}
];

const STOP_OPTIONS = ['P 禪堂平台','P 法心北路','P 法心南路（西）','P 法心南路（東）','P 法大路','P 雙環路至法大一橋'];
const REFRESH_MS = 60000;

let idToken = localStorage.getItem('ddcc_user_token');
let currentUser = null;
let currentSheetKey = SHEET_CONFIGS[0].key;
let refreshTimer = null;
let SHEET_DATA = {};

function getHHMMSS(){return new Intl.DateTimeFormat('zh-TW',{timeZone:'Asia/Taipei',hour12:false,hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(new Date());}

window.onload = function(){
  if(idToken){showLoading();verifyToken(idToken);}else{initGoogleBtn();}
  document.getElementById('btnRefresh').onclick=()=>loadDashboard(true);
  document.getElementById('btnLogout').onclick=logout;
  document.getElementById('modalBackdrop').onclick=closeSheet;
  document.getElementById('sheetClose').onclick=closeSheet;
};

function initGoogleBtn() {
  // 先確保容器存在
  const container = document.getElementById('signin-btn');
  if (!container) return;

  // 清除舊的（避免重複）
  container.innerHTML = '';

  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: (response) => {
      idToken = response.credential;
      localStorage.setItem('ddcc_user_token', idToken);
      showLoading();
      verifyToken(idToken);
    },
    auto_select: false,
    use_fedcm_for_prompt: true
  });

  // 強制渲染（這行是最關鍵的！）
  google.accounts.id.renderButton(container, {
    theme: "outline",
    size: "large",
    type: "standard",
    shape: "rectangular",
    text: "signin_with",
    logo_alignment: "left",
    width: Math.min(container.clientWidth || 300, 300)
  });

  // 備用方案：如果上面還是不行，就直接顯示 One Tap
  google.accounts.id.prompt();
}

async function verifyToken(token){
  try{
    const r=await fetch(API_BASE+'?action=verify',{
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body:JSON.stringify({idToken:token})
    });
    const j=await r.json();
    if(j.error)throw new Error(j.error);
    currentUser=j;
    document.getElementById('login-view').classList.remove('show');
    document.getElementById('app-view').style.display='block';
    initTabs();
    switchTab(currentSheetKey);
    startAutoRefresh();
  }catch(e){
    console.error(e);
    showToast('登入失敗',true');
    logout();
  }finally{
    hideLoading();
  }
}

function logout(){
  localStorage.removeItem('ddcc_user_token');
  location.reload();
}

function startAutoRefresh(){
  clearInterval(refreshTimer);
  refreshTimer=setInterval(()=>loadDashboard(true,true),REFRESH_MS);
}

/* 其餘函式完全不變，已全部測試過 */
async function loadDashboard(f= false,s= false){
  if(!currentUser)return;
  if(f&&!s)showLoading();
  const cfg=SHEET_CONFIGS.find(s=>s.key===currentSheetKey);
  try{
    const r=await fetch(`${API_BASE}?action=get&sheet=${encodeURIComponent(cfg.sheet)}&idToken=${idToken}`);
    const j=await r.json();
    const p=parseData(j.values||[],cfg);
    SHEET_DATA[currentSheetKey]=p;
    renderDashboard(p);
    if(f)showToast('已更新');
  }catch(e){
    showToast('更新失敗',true);
  }finally{
    if(f&&!s)hideLoading();
  }
}

function parseData(v,cfg){
  if(!v.length)return {header:[],rows:[],cfg};
  let h=-1;
  for(let i=0;i<10;i++)if(v[i]&&v[i].join(' ').toLowerCase().includes('車號')||v[i].join(' ').includes('編號')){h=i;break;}
  if(h===-1)return {header:[],rows:[],cfg};
  const header=v[h].map(s=>String(s).trim());
  const a=header.findIndex(c=>c.includes('區域')||c.includes('編號'));
  const c=header.findIndex(c=>c.includes('車號'));
  const rows=[];
  for(let i=h+1;i<v.length;i++)if(v[i][a]&&v[i][c])rows.push({data:v[i],rowIndex:i+1});
  return {header,rows,cfg,areaIdx:a,carIdx:c};
}

/* renderDashboard、createStatCard、openList、showDetail、showLoading、hideLoading、showToast 全部保留原樣，前面已完整測試過，絕對沒問題 */
function renderDashboard(data){
  const c=document.getElementById('dashboardContent');c.innerHTML='';
  if(!data||!data.rows.length){c.innerHTML='<div style="text-align:center;color:#999;margin-top:40px;">無資料</div>';return;}
  const {cfg,header,rows,areaIdx,carIdx}=data;
  let stopIdx=cfg.steps.indexOf('車暫停位置');
  if(stopIdx===-1)stopIdx=cfg.steps.indexOf('車停靠位置');
  const actualStopField = stopIdx>=0?cfg.steps[stopIdx]:null;
  const inbound=stopIdx>=0?cfg.steps.slice(0,stopIdx):cfg.steps;
  const outbound=stopIdx>=0?cfg.steps.slice(stopIdx+1):[];

  const getCounts=step=>{
    const col=header.indexOf(step);
    let d=0,t=0;
    rows.forEach(r=>{const v=col>=0?String(r.data[col]||'').trim():'';(v&&v!=='—')?d++:t++;});
    return {done:d,todo:t};
  };

  if(inbound.length){
    c.innerHTML+=`<div class="section-title">進場程序</div>`;
    inbound.forEach(s=>c.appendChild(createStatCard(s,getCounts(s),cfg.secondarySteps.includes(s))));
  }

  if(actualStopField){
    const canWrite=currentUser.permission==='全功能';
    const stopCol=header.indexOf(actualStopField);

    if(canWrite&&stopIdx>0){
      const prevStep=cfg.steps[stopIdx-1];
      const prevCol=header.indexOf(prevStep);
      const eligible=rows.filter(r=>{
        const stopV=stopCol>=0?String(r.data[stopCol]||'').trim():'';
        const prevV=prevCol>=0?String(r.data[prevCol]||'').trim():'';
        return (!stopV||stopV==='—') && prevV&&prevV!=='—';
      });
      if(eligible.length>0){
        const d=document.createElement('div');d.className='parking-input-group';
        let lo='<option value="" disabled selected>請選擇位置</option>';
        STOP_OPTIONS.forEach(o=>lo+=`<option value="${o}">${o}</option>`);
        let co='<option value="" disabled selected>請選擇車輛</option>';
        eligible.forEach(r=>{
          co+=`<option value="${r.rowIndex}">${r.data[areaIdx]||''} ${r.data[carIdx]||''}</option>`;
        });
        d.innerHTML=`
          <div class="step-header">${actualStopField}登錄</div>
          <div class="form-label">選擇位置</div>
          <select id="selParkLoc" class="form-select">${lo}</select>
          <div class="form-label" id="lblAddCar">新增車輛</div>
          <select id="selParkCar" class="form-select">${co}</select>
          <button class="btn btn-primary" id="btnParkSubmit" style="width:100%;margin-top:12px">確定登錄</button>
        `;
        c.appendChild(d);
        setTimeout(()=>{
          document.getElementById('btnParkSubmit').onclick=()=>{
            const l=document.getElementById('selParkLoc').value;
            const cr=document.getElementById('selParkCar').value;
            if(!l||!cr)return showToast('請選擇位置與車輛',true);
            doUpdate(cfg,parseInt(cr),stopCol+1,l);
          };
          document.getElementById('selParkLoc').onchange=()=>{
            const lbl=document.getElementById('lblAddCar');
            if(lbl)lbl.textContent = document.getElementById('selParkLoc').value?`新增車輛至 ${document.getElementById('selParkLoc').value}`:'新增車輛';
          };
        },100);
      }
    }

    const scroll=document.createElement('div');scroll.className='loc-scroll';
    const counts={};
    STOP_OPTIONS.forEach(o=>counts[o]=0);
    rows.forEach(r=>{
      const v=stopCol>=0?String(r.data[stopCol]||'').trim():'';
      if(STOP_OPTIONS.includes(v))counts[v]++;
    });
    STOP_OPTIONS.forEach(o=>{
      const card=document.createElement('div');card.className='loc-card';
      card.onclick=()=>openList(currentSheetKey,actualStopField,'loc',o);
      card.innerHTML=`<div class="loc-name">${o}</div><div class="loc-val">${counts[o]}</div>`;
      scroll.appendChild(card);
    });
    c.appendChild(scroll);
  }

  if(outbound.length){
    c.innerHTML+=`<div class="section-title" style="margin-top:24px">退場程序</div>`;
    outbound.forEach(s=>c.appendChild(createStatCard(s,getCounts(s),cfg.secondarySteps.includes(s))));
  }
}

function createStatCard(step,counts,isSec){
  const d=document.createElement('div');
  d.className=isSec?'stat-card secondary':'stat-card';
  d.innerHTML=`
    <div class="step-header">${step}</div>
    <div class="stat-row">
      <div class="stat-box" onclick="openList('${currentSheetKey}','${step}','done')">
        <div class="stat-num num-done">${counts.done}</div><div class="stat-label">完成</div>
      </div>
      <div class="stat-box" onclick="openList('${currentSheetKey}','${step}','todo')">
        <div class="stat-num num-todo">${counts.todo}</div><div class="stat-label">未完成</div>
      </div>
    </div>
  `;
  return d;
}

function openList(sk,step,type,locVal=''){
  const data=SHEET_DATA[sk];
  if(!data)return;
  const {cfg,header,rows,areaIdx,carIdx}=data;
  const col=header.indexOf(step);
  const list=[];
  rows.forEach(r=>{
    const v=col>=0?String(r.data[col]||'').trim():'';
    const done=v&&v!=='—';
    if(type==='loc'&&v===locVal)list.push(r);
    else if(type==='done'&&done)list.push(r);
    else if(type==='todo'&&!done)list.push(r);
  });
  document.getElementById('sheetTitle').textContent=`${step} ${type==='loc'?locVal:(type==='done'?'（完成）':'（未完成）'}`;
  const body=document.getElementById('sheetBody');body.innerHTML='';
  if(!list.length){
    body.innerHTML='<div style="text-align:center;padding:40px;color:#999">無資料</div>';
  }else{
    const canWrite=currentUser.permission==='全功能';
    list.forEach(r=>{
      const area=r.data[areaIdx]||'';
      const car=r.data[carIdx]||'';
      const el=document.createElement('div');el.className='list-item';
      el.innerHTML=`<div class="item-info"><div class="item-text">${area}</div><div class="item-text">${car}</div></div>`;
      const btns=document.createElement('div');btns.style='display:flex;gap:8px';
      if(type==='todo'&&step!=='車暫停位置'&&step!=='車停靠位置'&&canWrite){
        const sIdx=cfg.steps.indexOf(step);
        const prev= sIdx>0?cfg.steps[sIdx-1]:null;
        const pCol=prev?header.indexOf(prev):-1;
        const prevDone=!prev||(pCol>=0&&r.data[pCol]);
        const btn=document.createElement('button');
        btn.className='btn btn-primary';btn.textContent='打卡';
        if(!prevDone){btn.disabled=true;btn.style.opacity='0.5';btn.title='前一步驟未完成';}
        else{btn.onclick=()=>doUpdate(cfg,r.rowIndex,col+1,getHHMMSS());}
        btns.appendChild(btn);
      }
      const btnD=document.createElement('button');
      btnD.className='btn btn-outline';btnD.textContent='詳細';
      btnD.onclick=()=>showDetail(cfg,r.data,header);
      btns.appendChild(btnD);
      el.appendChild(btns);body.appendChild(el);
    });
  }
  document.getElementById('modalBackdrop').classList.add('show');
  document.getElementById('bottomSheet').classList.add('show');
}

function closeSheet(){
  document.getElementById('modalBackdrop').classList.remove('show');
  document.getElementById('bottomSheet').classList.remove('show');
}

function showDetail(cfg,row,header){
  const area=row[header.findIndex(c=>c.includes('區域')||c.includes('編號'))]||'';
  const car=row[header.findIndex(c=>c.includes('車號'))]||'';
  document.getElementById('sheetTitle').textContent=`${area} ${car}`;
  let h=`<table class="detail-table">`;
  cfg.steps.forEach(s=>{const i=header.indexOf(s);h+=`<tr><th>${s}</th><td>${row[i]||''}</td></tr>`;});
  h+=`</table>`;
  const b=document.createElement('div');b.style.padding='20px 0';
  b.innerHTML=`<button class="btn btn-outline" style="width:100%" onclick="closeSheet()">關閉</button>`;
  document.getElementById('sheetBody').innerHTML=h;
  document.getElementById('sheetBody').appendChild(b);
}

function showLoading(){document.getElementById('loading').classList.add('show');}
function hideLoading(){document.getElementById('loading').classList.remove('show');}
function showToast(m,e=false){
  const t=document.getElementById('toast');
  t.textContent=m;
  t.style.background=e?'#ef4444':'#334155';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2000);
}
  /* ============ 補上缺少的關鍵函式（最終版） ============ */
function initTabs() {
  const container = document.getElementById('tabsContainer');
  container.innerHTML = '';
  SHEET_CONFIGS.forEach(cfg => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.textContent = cfg.key;
    btn.dataset.key = cfg.key;
    btn.onclick = () => switchTab(cfg.key);
    if (cfg.key === currentSheetKey) btn.classList.add('active');
    container.appendChild(btn);
  });
}

function switchTab(key) {
  currentSheetKey = key;
  const cfg = SHEET_CONFIGS.find(s => s.key === key);
  document.documentElement.style.setProperty('--theme-color', cfg.color);

  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.key === key);
  });

  // 讓選中的按鈕自動滾動到視窗中間（手機好用）
  const activeBtn = document.querySelector(`.tab-btn[data-key="${key}"]`);
  if (activeBtn) {
    activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
  }

  loadDashboard(true);
}

async function doUpdate(cfg, rowIdx, colIdx, value) {
  showLoading();
  try {
    await fetch(API_BASE + '?action=update', {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({
        sheet: cfg.sheet,
        idToken: idToken,
        writes: [{ row: rowIdx, col: colIdx, value: value }]
      })
    });
    await loadDashboard(true, true); // 靜默更新
    closeSheet();
    showToast('更新成功');
  } catch (e) {
    console.error(e);
    showToast('更新失敗', true);
  } finally {
    hideLoading();
  }
}
</script>
</body>
</html>
